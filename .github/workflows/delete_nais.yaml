name: NAIS Delete

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Select branch to run the workflow on'
        required: true

jobs:
  delete:
    name: 'Delete app from cluster'
    permissions:
      contents: 'read'
      id-token: 'write'
    runs-on: ubuntu-latest
    if: (startsWith(github.head_ref, 'MIM-') || startsWith(github.head_ref, 'mim-') && contains(github.event.issue.labels.*.name, 'nais') && contains(fromJSON('["annesiri", "ssb-cgn", "Glenruben", "johnnadeluy", "Carl-OW", "michaelpande"]'), github.actor))
    steps:
      # Get the JIRA issue number (same logic from deploy)
      - name: 'Get JIRA issue number'
        id: jira_issue_number
        run: |
          BRANCH="${{ github.head_ref }}"
          ISSUE_NUMBER=${BRANCH:0:8}
          ISSUE_NUMBER=$(echo $ISSUE_NUMBER | tr '[:upper:]' '[:lower:]')
          echo "ISSUE_NUMBER=${ISSUE_NUMBER}" >> $GITHUB_ENV;
          echo "Issue number: $ISSUE_NUMBER";

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2.1.6'
        with:
          workload_identity_provider: 'projects/906675412832/locations/global/workloadIdentityPools/ssb-identity-pool/providers/github-oidc-provider'
          service_account: 'gh-ssb@nais-management-b3a7.iam.gserviceaccount.com'
          token_format: 'access_token'

      # Skip the GKE credentials step (this is where the issue happens)
      # - id: 'get-credentials'
      #   uses: 'google-github-actions/get-gke-credentials@v2.2.1'
      #   with:
      #     cluster_name: 'nais-test'
      #     location: 'europe-north1'

      # Redeploy the application with TTL set to 0
      - name: 'Set TTL to 0 in nais.yaml'
        run: |
          sed -i 's/ttl: .*/ttl: 0/' ../../nais.yaml

      # Redeploy the application with the modified TTL
      - uses: nais/deploy/actions/deploy@v2
        env:
          APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
          CLUSTER: test
          RESOURCE: nais.yaml
          VAR: image=${{ env.REGISTRY }}/${{env.IMAGE}}:${{ env.TAG }},branch=${{ env.ISSUE_NUMBER }}
          DEPLOY_SERVER: deploy.ssb.cloud.nais.io:443
